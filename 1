<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TACTICAL IMPACT MONITOR v5.4</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Roboto+Mono:wght@500&display=swap');

        :root {
            --bg-dark: #0f1113;
            --card-bg: #1a1d21;
            --accent-blue: #3782f0;
            --accent-green: #00e676;
            --accent-orange: #ff9100;
            --accent-red: #ff1744;
            --text-main: #e0e0e0;
            --text-sub: #78909c;
            --font-mono: 'Roboto Mono', monospace;
            --header-height: 60px;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Noto Sans JP', sans-serif;
            margin: 0;
            padding: 8px;
            padding-top: calc(var(--header-height) + 20px);
            display: flex;
            flex-direction: column;
            align-items: center;
            user-select: none; 
        }

        .sticky-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: var(--header-height);
            background: rgba(26, 29, 33, 0.95);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid #333;
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        .header-content {
            width: 100%;
            max-width: 440px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 15px;
        }

        .app-title {
            font-size: 0.8em;
            color: var(--accent-blue);
            font-weight: bold;
            letter-spacing: 1px;
            text-align: center;
            margin-bottom: 4px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            width: 100%;
            max-width: 440px;
            box-sizing: border-box;
        }

        .utc-display { font-size: 1.4em; color: var(--accent-green); font-family: var(--font-mono); }
        .toggle-btn { background: #2c313a; border: 1px solid #555; color: #fff; font-size: 0.7em; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
        .toggle-btn.paused { background: var(--accent-red); border-color: var(--accent-red); }

        .settings-label { font-size: 0.7em; color: var(--text-sub); margin-bottom: 4px; display: block; text-transform: uppercase; }

        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .num-input::-webkit-inner-spin-button, .num-input::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .num-input { -moz-appearance: textfield; }
        .num-input, .select-input { width: 100%; background: #2c313a; border: 1px solid #444; border-radius: 4px; color: var(--accent-green); font-family: var(--font-mono); font-size: 1.1em; padding: 8px; box-sizing: border-box; text-align: center; }

        .rally-selector { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; margin-bottom: 12px; }
        .rally-opt { background: #2c313a; border: 1px solid #444; border-radius: 4px; text-align: center; padding: 8px 0; font-size: 0.8em; cursor: pointer; color: var(--text-sub); }
        .rally-opt.active { background: var(--accent-blue); border-color: var(--accent-blue); color: white; font-weight: bold; }

        .control-row { display: flex; align-items: center; gap: 6px; margin-bottom: 10px; }
        input[type="range"] { flex-grow: 1; accent-color: var(--accent-blue); }
        .step-btn { width: 44px; height: 44px; background: #2c313a; border: 1px solid #444; border-radius: 4px; color: white; font-size: 1.2em; flex-shrink: 0; }
        .val-display { min-width: 55px; text-align: right; font-size: 1em; color: var(--accent-green); font-family: var(--font-mono); }

        .main-btn { width: 100%; padding: 16px; background: var(--accent-blue); color: white; border: none; border-radius: 6px; font-size: 1.1em; font-weight: bold; margin-top: 5px; cursor: pointer; }
        
        .copy-container { margin-top: 12px; }
        .copy-area { background: #000; padding: 12px; border-radius: 4px; font-family: var(--font-mono); font-size: 1.1em; color: var(--accent-green); white-space: pre-wrap; text-align: left; border: 1px solid #333; line-height: 1.4; margin-bottom: 8px; user-select: text; }
        .copy-btn { width: 100%; padding: 10px; background: #2c313a; color: var(--text-main); border: 1px solid #444; border-radius: 6px; font-size: 0.9em; font-weight: bold; cursor: pointer; }

        .summary-card { background: rgba(255,255,255,0.03); border: 1px solid #333; }
        .summary-item { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; }
        .summary-label { font-size: 0.8em; color: var(--text-sub); }
        .summary-val { font-size: 1.1em; font-family: var(--font-mono); color: #fff; }

        .action-card { border: 2px solid var(--accent-blue); background: #111; text-align: center; padding: 15px 10px; margin-top: 8px; }
        .action-title { font-size: 0.7em; color: var(--text-sub); margin-bottom: 4px; }
        .action-time { font-size: 1.4em; font-family: var(--font-mono); color: #fff; margin-bottom: 12px; border-bottom: 1px solid #333; display: inline-block; padding: 0 20px; }
        .status-container { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .status-label { font-size: 1.0em; font-weight: bold; color: var(--accent-blue); margin-bottom: -5px; }
        .cd-val { font-size: 5.0em; font-family: var(--font-mono); font-weight: bold; line-height: 1.1; color: var(--accent-green); letter-spacing: -2px; }
        .buffer-badge { color: var(--accent-blue); font-size: 0.85em; font-weight: bold; border: 1px solid var(--accent-blue); padding: 0 4px; border-radius: 3px; }
    </style>
</head>
<body>

    <header class="sticky-header">
        <div class="header-content">
            <div id="current-utc" class="utc-display">00:00:00.00</div>
            <button id="pause-btn" class="toggle-btn" onclick="togglePause()">PAUSE</button>
        </div>
    </header>

    <div class="app-title">TACTICAL IMPACT MONITOR v5.4</div>

    <div class="card">
        <span class="settings-label">ターゲット選択</span>
        <select id="target-name" class="select-input" onchange="calcRally()" style="margin-bottom:12px; color: #fff; font-weight: bold;">
            <option value="STF">STF</option>
            <option value="YDK">YDK</option>
            <option value="敵">敵</option>
            <option value="敵ゴースト">敵ゴースト</option>
        </select>

        <span class="settings-label">集結モード</span>
        <div class="rally-selector">
            <div class="rally-opt" onclick="setRallyBase(60, this)">1min</div>
            <div class="rally-opt active" onclick="setRallyBase(300, this)">5min</div>
            <div class="rally-opt" onclick="setRallyBase(600, this)">10min</div>
        </div>

        <div class="input-row">
            <div>
                <span class="settings-label"><span class="target-label">STF</span>の行軍 (s)</span>
                <input type="number" id="other-s" class="num-input" value="45" inputmode="numeric" 
                       onfocus="this.value=''" oninput="validateNumInput(this)">
            </div>
            <div>
                <span class="settings-label">自分の行軍 (s)</span>
                <input type="number" id="my-s" class="num-input" value="40" inputmode="numeric" 
                       onfocus="this.value=''" oninput="validateNumInput(this)">
            </div>
        </div>

        <span class="settings-label">集結残り時間</span>
        <div class="control-row">
            <button class="step-btn" onclick="step('rem-time', -1)">−</button>
            <input type="range" id="rem-time-s" min="0" max="300" value="300" oninput="syncRem(this.value)">
            <button class="step-btn" onclick="step('rem-time', 1)">+</button>
            <div class="val-display" id="rem-time-val">5:00</div>
        </div>

        <span class="settings-label">着弾バッファー</span>
        <select id="buffer-s" class="select-input" onchange="calcRally()" style="margin-bottom:10px;">
            <option value="0">0s (ジャスト)</option>
            <option value="10">10s</option>
            <option value="20" selected>20s</option>
            <option value="30">30s</option>
            <option value="40">40s</option>
            <option value="50">50s</option>
            <option value="60">60s</option>
        </select>

        <button class="main-btn" onclick="calcRally()">SYNC DATA</button>

        <div class="copy-container">
            <div id="copy-text" class="copy-area">--</div>
            <button class="copy-btn" onclick="copyLogic()">COPY FOR CHAT</button>
        </div>
    </div>

    <div class="card summary-card">
        <div class="summary-item">
            <span class="summary-label"><span class="target-label">STF</span>着弾</span>
            <span id="arrival-target-display" class="summary-val">UTC: 00:00:00</span>
        </div>
        <div class="summary-item" style="border-top: 1px dashed #333; margin-top: 4px; padding-top: 8px;">
            <span class="summary-label"><span class="target-label">STF</span>着弾 <span id="buffer-label-small" style="color:var(--accent-blue)">(buffer+20s)</span></span>
            <span id="arrival-my-display" class="summary-val" style="color:var(--accent-blue);">UTC: 00:00:00</span>
        </div>
    </div>

    <div class="card action-card">
        <div class="action-title">出征予定時刻 (Buffer込 <span id="buffer-val-badge" class="buffer-badge">+20s</span>)</div>
        <div id="target-time-display" class="action-time">00:00:00</div>
        <div class="status-container">
            <div id="status-label" class="status-label">あなたの行軍開始まで残り</div>
            <div id="cd-rally" class="cd-val">0.00</div>
        </div>
    </div>

    <script>
        let targetActionMs = 0;
        let isPaused = false;

        function validateNumInput(el) {
            el.value = el.value.replace(/[^0-9]/g, '');
            calcRally();
        }

        function togglePause() {
            isPaused = !isPaused;
            const btn = document.getElementById('pause-btn');
            if (isPaused) { btn.innerText = "RESUME"; btn.classList.add('paused'); }
            else { btn.innerText = "PAUSE"; btn.classList.remove('paused'); calcRally(); }
        }

        function setRallyBase(sec, el) {
            document.querySelectorAll('.rally-opt').forEach(opt => opt.classList.remove('active'));
            el.classList.add('active');
            const slider = document.getElementById('rem-time-s');
            slider.max = sec; slider.value = sec; syncRem(sec);
        }

        function syncRem(val) {
            const m = Math.floor(val / 60);
            const s = val % 60;
            document.getElementById('rem-time-val').innerText = `${m}:${s.toString().padStart(2, '0')}`;
            document.getElementById('rem-time-s').value = val;
            calcRally();
        }

        function step(id, delta) {
            const el = document.getElementById(id + '-s');
            const newVal = Math.max(el.min, Math.min(el.max, parseInt(el.value) + delta));
            syncRem(newVal);
        }

        function formatFullUTC(ms) {
            const d = new Date(ms);
            return `${String(d.getUTCHours()).padStart(2, '0')}:${String(d.getUTCMinutes()).padStart(2, '0')}:${String(d.getUTCSeconds()).padStart(2, '0')}`;
        }

        function formatShortUTC(ms) {
            const d = new Date(ms);
            const m = String(d.getUTCMinutes()).padStart(2, '0');
            const s = String(d.getUTCSeconds()).padStart(2, '0');
            return `U${m}.${s}`;
        }

        setInterval(() => {
            if (isPaused) return;
            const now = new Date();
            const h = String(now.getUTCHours()).padStart(2, '0');
            const m = String(now.getUTCMinutes()).padStart(2, '0');
            const s = String(now.getUTCSeconds()).padStart(2, '0');
            const ms = String(Math.floor(now.getUTCMilliseconds() / 10)).padStart(2, '0');
            document.getElementById('current-utc').innerText = `${h}:${m}:${s}.${ms}`;
            
            if (targetActionMs > 0) {
                const diff = (targetActionMs - now.getTime()) / 1000;
                const cdEl = document.getElementById('cd-rally');
                const label = document.getElementById('status-label');
                const actionCard = document.querySelector('.action-card');

                if (diff > 0) {
                    cdEl.innerText = diff.toFixed(2);
                    label.innerText = "あなたの行軍開始まで残り";
                    if (diff > 30) {
                        label.style.color = "var(--accent-blue)";
                        cdEl.style.color = "var(--accent-green)";
                        actionCard.style.borderColor = "var(--accent-blue)";
                    } else if (diff > 10) {
                        label.style.color = "var(--accent-orange)";
                        cdEl.style.color = "var(--accent-orange)";
                        actionCard.style.borderColor = "var(--accent-orange)";
                    } else {
                        label.style.color = "var(--accent-red)";
                        cdEl.style.color = "var(--accent-red)";
                        actionCard.style.borderColor = "var(--accent-red)";
                    }
                } else if (diff > -2) {
                    cdEl.innerText = "GO!";
                    label.innerText = "行軍開始"; label.style.color = "var(--accent-green)";
                    cdEl.style.color = "white";
                    actionCard.style.borderColor = "var(--accent-green)";
                } else {
                    cdEl.innerText = "0.00";
                    label.innerText = "終了"; label.style.color = "#555";
                    cdEl.style.color = "#555";
                    actionCard.style.borderColor = "#333";
                }
            }
        }, 10);

        function calcRally() {
            const nowMs = Date.now();
            const remSec = parseInt(document.getElementById('rem-time-s').value) || 0;
            const otherSec = parseInt(document.getElementById('other-s').value) || 0;
            const mySec = parseInt(document.getElementById('my-s').value) || 0;
            const bufferSec = parseInt(document.getElementById('buffer-s').value) || 0;
            const targetName = document.getElementById('target-name').value;

            document.querySelectorAll('.target-label').forEach(el => el.innerText = targetName);
            
            const arrivalTargetMs = nowMs + ((remSec + otherSec) * 1000);
            const myArrivalMs = arrivalTargetMs + (bufferSec * 1000);
            targetActionMs = myArrivalMs - (mySec * 1000);

            document.getElementById('arrival-target-display').innerText = "UTC: " + formatFullUTC(arrivalTargetMs);
            document.getElementById('arrival-my-display').innerText = "UTC: " + formatFullUTC(myArrivalMs);
            document.getElementById('target-time-display').innerText = formatFullUTC(targetActionMs);
            document.getElementById('buffer-val-badge').innerText = `+${bufferSec}s`;
            document.getElementById('buffer-label-small').innerText = `(buffer+${bufferSec}s)`;

            const copyTxt = `${targetName}着弾(buffer+${bufferSec}s)\n${formatShortUTC(myArrivalMs)}`;
            document.getElementById('copy-text').innerText = copyTxt;
        }

        function copyLogic() {
            const txt = document.getElementById('copy-text').innerText;
            if(txt === "--") return;
            navigator.clipboard.writeText(txt).then(() => {
                const btn = document.querySelector('.copy-btn');
                btn.innerText = "COPIED!"; btn.style.background = "var(--accent-green)"; btn.style.color = "#000";
                setTimeout(() => { 
                    btn.innerText = "COPY FOR CHAT"; btn.style.background = "#2c313a"; btn.style.color = "var(--text-main)";
                }, 1000);
            });
        }
        
        calcRally();
    </script>
</body>
</html>
