<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TACTICAL IMPACT MONITOR v6.7</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Roboto+Mono:wght@500&display=swap');

        :root {
            --bg-light: #f4f6f8;       /* 薄いグレー */
            --card-bg: #ffffff;        /* 白 */
            --accent-sakura: #ffb7c5;  /* さくら色 */
            --accent-sky: #87ceeb;     /* 空色 */
            --text-main: #333d47;      /* 濃いグレー */
            --text-sub: #90a4ae;       /* 補助文字 */
            --font-mono: 'Roboto Mono', monospace;
            --header-height: 60px;
        }

        body {
            background-color: var(--bg-light);
            color: var(--text-main);
            font-family: 'Noto Sans JP', sans-serif;
            margin: 0;
            padding: 8px;
            padding-top: calc(var(--header-height) + 20px);
            display: flex;
            flex-direction: column;
            align-items: center;
            user-select: none; 
            /* ダブルタップズームを防止 */
            touch-action: manipulation;
        }

        /* ヘッダー：UTCを中央、msボタンを右寄せ */
        .sticky-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: var(--header-height);
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 1px solid #e0e0e0;
            z-index: 1000;
            display: grid;
            grid-template-columns: 60px 1fr 60px;
            align-items: center;
        }

        .utc-display { 
            grid-column: 2;
            justify-self: center;
            font-size: 1.6em; 
            color: var(--text-main); 
            font-family: var(--font-mono); 
            font-weight: bold; 
        }

        .ms-toggle {
            grid-column: 3;
            justify-self: start;
            background: transparent;
            border: 1px solid #ddd;
            color: #ccc;
            font-size: 0.7em;
            width: 34px;
            height: 24px;
            padding: 0;
            border-radius: 4px;
            cursor: pointer;
            font-family: var(--font-mono);
            transition: 0.2s;
            touch-action: manipulation;
        }
        .ms-toggle.active {
            background: var(--accent-sky);
            border-color: var(--accent-sky);
            color: white;
        }

        .app-title {
            font-size: 0.8em;
            color: var(--text-sub);
            font-weight: bold;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 10px;
            width: 100%;
            max-width: 440px;
            box-sizing: border-box;
            border: 1px solid #eee;
        }

        .settings-label { font-size: 0.75em; color: var(--text-sub); margin-bottom: 6px; display: block; font-weight: bold; }

        .num-input, .select-input { 
            width: 100%; 
            background: #fff; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            color: var(--text-main); 
            font-family: var(--font-mono); 
            font-size: 1.1em; 
            padding: 10px; 
            box-sizing: border-box; 
            text-align: center;
            outline: none;
            touch-action: manipulation;
        }

        .rally-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }
        .rally-opt { background: #f8f9fa; border: 1px solid #eee; border-radius: 4px; text-align: center; padding: 10px 0; font-size: 0.9em; cursor: pointer; color: var(--text-sub); touch-action: manipulation; }
        .rally-opt.active { background: var(--accent-sky); border-color: var(--accent-sky); color: white; font-weight: bold; }

        .control-row { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
        input[type="range"] { flex-grow: 1; accent-color: var(--accent-sky); touch-action: manipulation; }
        
        .step-btn { 
            width: 40px; height: 40px; 
            background: #eee; border: none; 
            border-radius: 4px; color: var(--text-main); 
            font-size: 1.2em; cursor: pointer;
            touch-action: manipulation;
        }
        .step-btn:active { background: #ddd; }

        .main-btn { 
            width: 100%; padding: 14px; 
            background: var(--accent-sakura); color: white; 
            border: none; border-radius: 4px; 
            font-size: 1.1em; font-weight: bold; 
            margin-top: 5px; cursor: pointer;
            touch-action: manipulation;
        }
        .main-btn:active { opacity: 0.8; }
        
        .copy-area { 
            background: #fafafa; padding: 12px; border-radius: 4px; 
            font-family: var(--font-mono); font-size: 1.1em; 
            color: var(--text-main); white-space: pre-wrap; 
            text-align: left; border: 1px solid #eee; 
            line-height: 1.4; margin-bottom: 10px; 
        }
        .copy-btn { 
            width: 100%; padding: 10px; 
            background: transparent; color: var(--text-sub); 
            border: 1px solid #ddd; border-radius: 4px; 
            font-size: 0.9em; cursor: pointer; 
            touch-action: manipulation;
        }

        .summary-card { border-top: 3px solid var(--accent-sky); }
        .summary-item { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; }
        .summary-label { font-size: 0.85em; color: var(--text-sub); font-weight: bold; }
        .summary-val { font-size: 1.4em; font-family: var(--font-mono); color: var(--text-main); font-weight: bold; }
        
        .buffer-badge { 
            color: var(--accent-sky); font-size: 0.8em; 
            background: #eef9ff; padding: 2px 6px; 
            border-radius: 4px; font-family: var(--font-mono);
        }
    </style>
</head>
<body>

    <header class="sticky-header">
        <div id="current-utc" class="utc-display">00:00:00</div>
        <button id="ms-toggle-btn" class="ms-toggle" onclick="toggleMs()">ms</button>
    </header>

    <div class="app-title">TACTICAL IMPACT MONITOR v6.7</div>

    <div class="card">
        <span class="settings-label">ターゲット</span>
        <select id="target-name" class="select-input" onchange="calcRally()" style="margin-bottom:12px;">
            <option value="STF">STF</option>
            <option value="YDK">YDK</option>
            <option value="敵">敵</option>
            <option value="敵ゴースト">敵ゴースト</option>
        </select>

        <span class="settings-label">集結モード</span>
        <div class="rally-selector">
            <div class="rally-opt active" onclick="setRallyBase(300, this)">5min</div>
            <div class="rally-opt" onclick="setRallyBase(600, this)">10min</div>
        </div>

        <div style="margin-bottom:12px;">
            <span class="settings-label"><span class="target-label">STF</span>への行軍時間 (s)</span>
            <input type="number" id="other-s" class="num-input" value="45" inputmode="numeric" onfocus="this.select()" oninput="calcRally()">
        </div>

        <span class="settings-label">集結残り時間</span>
        <div class="control-row">
            <button class="step-btn" onclick="step('rem-time', -1)">−</button>
            <input type="range" id="rem-time-s" min="0" max="600" value="300" oninput="syncRem(this.value)">
            <button class="step-btn" onclick="step('rem-time', 1)">+</button>
            <div class="val-display" id="rem-time-val">5:00</div>
        </div>

        <span class="settings-label">着弾バッファー (s)</span>
        <input type="number" id="buffer-s" class="num-input" value="20" inputmode="numeric" style="margin-bottom:16px;" onfocus="this.select()" oninput="calcRally()">

        <button class="main-btn" onclick="calcRally()">SYNC DATA</button>
    </div>

    <div class="card summary-card">
        <div class="summary-item">
            <span class="summary-label"><span class="target-label">STF</span> 着弾</span>
            <span id="arrival-target-display" class="summary-val">00:00:00</span>
        </div>
        <div class="summary-item" style="border-top: 1px solid #f8f8f8; margin-top: 4px; padding-top: 8px;">
            <span class="summary-label">
                自軍着弾
                <span id="buffer-val-badge" class="buffer-badge">+20s</span>
            </span>
            <span id="arrival-my-display" class="summary-val" style="color:var(--accent-sky);">00:00:00</span>
        </div>
    </div>

    <div class="card">
        <div id="copy-text" class="copy-area">--</div>
        <button class="copy-btn" onclick="copyLogic()">COPY FOR CHAT</button>
    </div>

    <script>
        let showMs = false; 

        function toggleMs() {
            showMs = !showMs;
            const btn = document.getElementById('ms-toggle-btn');
            if (showMs) btn.classList.add('active');
            else btn.classList.remove('active');
        }

        function setRallyBase(sec, el) {
            document.querySelectorAll('.rally-opt').forEach(opt => opt.classList.remove('active'));
            el.classList.add('active');
            const slider = document.getElementById('rem-time-s');
            slider.max = sec; slider.value = sec; syncRem(sec);
        }

        function syncRem(val) {
            const m = Math.floor(val / 60);
            const s = val % 60;
            document.getElementById('rem-time-val').innerText = `${m}:${s.toString().padStart(2, '0')}`;
            document.getElementById('rem-time-s').value = val;
            calcRally();
        }

        function step(id, delta) {
            const el = document.getElementById(id + '-s');
            const newVal = Math.max(0, Math.min(parseInt(el.max), parseInt(el.value) + delta));
            syncRem(newVal);
        }

        function formatFullUTC(ms) {
            const d = new Date(ms);
            return `${String(d.getUTCHours()).padStart(2, '0')}:${String(d.getUTCMinutes()).padStart(2, '0')}:${String(d.getUTCSeconds()).padStart(2, '0')}`;
        }

        function formatShortUTC(ms) {
            const d = new Date(ms);
            const m = String(d.getUTCMinutes()).padStart(2, '0');
            const s = String(d.getUTCSeconds()).padStart(2, '0');
            return `U${m}.${s}`;
        }

        setInterval(() => {
            const now = new Date();
            const h = String(now.getUTCHours()).padStart(2, '0');
            const m = String(now.getUTCMinutes()).padStart(2, '0');
            const s = String(now.getUTCSeconds()).padStart(2, '0');
            
            let timeStr = `${h}:${m}:${s}`;
            if (showMs) {
                const ms = String(Math.floor(now.getUTCMilliseconds() / 10)).padStart(2, '0');
                timeStr += `.${ms}`;
            }
            document.getElementById('current-utc').innerText = timeStr;
        }, 10);

        function calcRally() {
            const nowMs = Date.now();
            const remSec = parseInt(document.getElementById('rem-time-s').value) || 0;
            const otherSec = parseInt(document.getElementById('other-s').value) || 0;
            const bufferSec = parseInt(document.getElementById('buffer-s').value) || 0;
            const targetName = document.getElementById('target-name').value;

            document.querySelectorAll('.target-label').forEach(el => el.innerText = targetName);
            document.getElementById('buffer-val-badge').innerText = `+${bufferSec}s`;
            
            const arrivalTargetMs = nowMs + ((remSec + otherSec) * 1000);
            const myArrivalMs = arrivalTargetMs + (bufferSec * 1000);

            document.getElementById('arrival-target-display').innerText = formatFullUTC(arrivalTargetMs);
            document.getElementById('arrival-my-display').innerText = formatFullUTC(myArrivalMs);

            const copyTxt = `${targetName}着弾(buffer+${bufferSec}s)\n${formatShortUTC(myArrivalMs)}`;
            document.getElementById('copy-text').innerText = copyTxt;
        }

        function copyLogic() {
            const txt = document.getElementById('copy-text').innerText;
            if(txt === "--") return;
            navigator.clipboard.writeText(txt).then(() => {
                const btn = document.querySelector('.copy-btn');
                const originalText = btn.innerText;
                btn.innerText = "COPIED!"; btn.style.color = "var(--accent-sakura)";
                setTimeout(() => { 
                    btn.innerText = originalText; btn.style.color = "var(--text-sub)";
                }, 1000);
            });
        }
        
        calcRally();
    </script>
</body>
</html>
